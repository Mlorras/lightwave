# Lightwave Certiticate Authority
**VMCA** or **Lightwave Certificate Authority** is a certificate server that
implements a set of Public Key Crypto Standards (henceforth called
PKCS). The certificate authority's main functionality is to issue
Certificates to authenticated Lightwave Users.

## Introduction
The primary purpose of VMCA is to issue certificates that allow various services and machines to establish trust to each other. This is achieved primarily by adding the VMCA Root CA certificate to the trusted store of each computer that is part of Lightwave domain.

## Modes of Operation - Root CA and Intermediary CA
VMCA can operate in two modes, as a Root CA, from which all trust come up or as an intermediary CA of an enterprise CA. In the first mode, VMCA is initialised with a self signed certificate and in the second mode, an Enterprise CA signs the Certificate Signing Request (CSR) that the VMCA generates and the administrator configures VMCA to use this certificate and keys.

## Certificate types and usage scenarios
The certificates that are issued to the primary service itself, will follow a X500 Name format, that will allow us to locate that service in the Lightwave directory. In other words, an service like SSO will be issued a certificate with the Subject Name as "CN=SSO, CN=Users, DC=LDU-xxxxxxxxxx, DC=vsphere, DC=local". This is a fully qualified Subject DN and for this certificate to be issued the entity must exist in the Lightwave directory.

The second type of certificates issued by VMCA are certificates that are issued on behalf of, which means that VMCA might have to issue certificates for entities that are not present in the directory. In such cases, the identity and access levels of the requester is established before the certificate is issued. In those cases the Subject Name is generated by the requester and may not be in the X500 Format. To request for this second class of certificates the requester must have an account in Lightwave and must also be a member in the Cert-Requester or CA-Administrator group.

At this point of time only two types of certificates key usages are supported by VMCA ( to be frank all key usage sceneries are supported, however from the business perspective only 2 is required.)

They are

1) Certificates that establish Identity -- This is the most common form of certificate that is issued, and the general use case for this certificate is to establish the identity for the person/ Machine / Component that is using the certificate.

2) Certificates that allow Intermediary CAs to be established - In order for a certificate to be used for purposes for issuing further certificates, that certificate but contain a capability called CA Certificate. if a user wants to get a Certificate that can be used for seeding other intermediary CAs, then the user has to be a Administrator.

## Installation, Configuration and Access of VMCA
VMCA or the Lightwave Certificate Server is installed as part of lightwave and the lightwave-server packages.

If you are installing VMCA from built source, make sure to install likewise service manager, lightwave directory service (vmdir) and Lightwave Authentication Framework (VMAFD).


## Access of VMCA
VMCA can be accessed via API or a command line tool at this point of time. The command line tool is called [certool](#certool)

VMCA can also be accessed via APIs, currently we support APIs in C, Java and Python. A detailed documentation of the C API can be found [here](vmca-c-api.md).

These API provide the ability to request new certificates and enumerate the current certificates issued by VMCA.

The notion of CRLs are provided by the enumeration APIs at this point of time

## Identity in VMCA
All identity in VMCA comes from Lightwave Directory Service.

## Certificate Names
As discussed earlier, VMCA certificates can have two naming conventions, X500 for entities that our directory server knows about, and some ASCII strings for things that are not known. However the only way to get certificates for objects that are in inside the Lightwave Directory Server is to be a CA-Admin and ask for certificates.


## Certificate Life-Cycle
### Private Keys
In order to request a certificate the requesting application must create private keys ( any key length less than 1024 will be rejected) the default length of Keys is 2048 bits. It is the responsibility of the application to maintain the passwords securely

### Certificate Requests
Once the keys are generated the application creates a Certificate Signing Request ( CSR -PKCS#10) which is cross signed with the applications private key. This operation is performed completely with the client machine. Once the CSR is created the Client machine connects to VMCA Server and send the request to the Server.

### Certificate Issuance
Once a CSR is received the VMCA server validates the Principal which it is communicating with, once the identity is established VMCA checks the ACLs to make sure that the principal that it is communicating with is authorized to perform the requested action. if the Access Checks succeed, then certificate specific properties are checked. The major properties checked by VMCA are

   1) No * in Subject Alt Name
   2) *.Domain Name is allowed if the Current Domain that VMCA is operating is same.
   3) The life time of the certificate requested is less than the life time of the Root CA certificate

VMCA uses a synchronous mechanism to issue certificates, so there is no need to check for the status of a CSR.

## Certificate Renewal , Re-Key and Modification
VMCA does *not* support renewal, Re-Key or Modification of certificates, the only way to alter a certificate is to revoke the certificate and issue a new certificate with the changes needed.

   The Client (certool) plans to provide a way to read from a certificate and create a CSR directly to make it easy to re-issue certificates when they expire.
## Certificate Revocation and Suspension
VMCA does *not* support Suspension of certificates, the only way a certificate can be rendered useless is to revoke it. In order to revoke a certificate, either you must be the owner of the certificate ( that is a certificate that is issued to you on your name), or must have CA-Admin or have higher privileges.

## Propagation of Revoked Certificates
Since VMCA provides certification enumeration APIs the CRL list is always up-to-date. The Clients who use VMCA is expected to make frequent queries to retrieve a list of expired or revoked certificates.

## Certificate Status Check API
Along with Enumerate certificate API, VMCA also offers a Check Status API for a certificate.

## Certool

The Certool is a command line tool for working against VMCA. This tool has two broad categories of functionality. The Admin functions that lets the user initialize the VMware Certificate server, and a bunch of certificate management functions. This document discusses both these categories Certool – VMCA Initialization functions For any certificate server to start issuing certificates it must have a root certificate which is trusted by other parties which is intending to use the certificate authority. In fact this certificate lets the users understand that he/she is talking to some entity that they trust. There are 3 distinct ways to populate this information in the VMware certificate server. They are

1. Create a Certificate Signing Request for other Enterprise CAs to Sign
2. Create a self signed certificate
3. Upload and existing Certificate and its private key into the VMware Certificate server.

In order to create a CSR, the user has to generate a private key / public key pair and create a blob that describes the personal information. The Certool makes it easy, by providing a simple command to do this.
```
certool --initcsr --privkey=RootCAPrivate.key --pubkey=RootCAPublic.key --csrfile=RootCSR.csr
```
This command creates 3 files on the machine, RootCAPrivate.Key which is the private key for the CA Server ( the user must protect this file), a public key and a CSR file. The user can take this CSR file to any enterprise CA and get it signed. Then this CA cert will be used by the VMCA to sign all its certificates, and a chain of trust that goes all the way to Enterprise CA is build in the network. This is the most secure and preferred way to initializing a CA Certificate.

If the above method is not possible, then the user is free to use other two methods, namely self signed CA Cert or uploading of an existing certificate. The commands to do so are simple,
```
certool --selfca
```
Will create a self signed CA. Please note it will read all values needed for the certificate from the certool.cfg. if you want to override any value either use the –Name=”CerToolCA” kind of syntax or open up the certool.cfg and edit it. The format is self explaining.
```
certool --rootca --cert=certfilename --privkey=privkeyfile
```
Will upload an existing certificate and private key to the server

### Certificate Management
This section talks about the Certificate management functions offered by the certool. • Generate Keys This function allows the user to create a private / public key pair. The command for doing this is
```
certool --genkey --privkey=<file name for the new private key> --pubkey=<file name for the pubkey>
```
• Generate Certificate This function allows the user to create a new certificate and pair it with a public/private key pair. In order to use this function the user must have a key pair with him.
```
certool --gencert --privkey=private.key
```
This function reads all the values from a config file, the default config file is called certool.cfg, this can be over ridden by using –config=<file name> option.

The config file has the following fields with the default values Country = US Name= VMCA DO NOT USE Organization = VMware OrgUnit = VMware Engineering State = California Locality = Palo Alto IPAddress = 127.0.0.1 Email = vmca@vmware.com Hostname = machine.vmware.com There are two ways to change the values in the config file, one is to edit the config file and the other is to over ride values in the command line. For example
```
certool --gencert --privkey=private.key --Name=”Anu” will create a certificate with Anu as Name parameter instead of VMCA DO NOT USE.
```
• Revoke Certificate The revoke certificate takes a certificate and tells the VMCA to revoke the certificate. The command line for doing this is
```
certool --revoke --cert=<cert file>
```
• View Certificate This command prints out the certificate in human readable form. The command line is
```
certool --viewcert --cert=<certfile>
```
• Get Root CA Cert This command allows the users to get the Root CA certificate , at this point of time it just prints out the Root CA certificate in human readable form. The command line to do so is
```
certool --getrootca
```
• Enumerate Certificates This command allows the user to browse the CA servers certificate repository. The command line is
```
certool --enumcert --filter=all
```
The filter can take the following values, All – means all the certificates in the repository Revoked = means only revoked certificates Expired – means all the expired certificates Active – means all valid certificates at that point of time.

The server also supports two misc. functions. One is the ability to talk to remote VMCAs. In order to do that, the user can specify – server=servername for any command.

The server also supports a notion of version string, this server version can be accessed thru certool using the
```
certool --version
```